{% extends "base.njk" %}

{% block head %}
  <link rel="stylesheet" href="../../../styles/show.css">
{% endblock %}

{% block content %}

<div class="type-cell-page">
  {% if show.category == "audio" %}
    <span class="type-label-page audio-label-page">audio</span>
  {% elif "misc" in show.category %}
    <span class="type-label-page misc-label-page">misc</span>
  {% endif %}
  
  {% if show.notes and show.notes | trim != '' %}
    <span class="note-block" onclick="this.classList.toggle('expanded')">
      <strong>Note:</strong> {{ show.notes }}
    </span>
  {% endif %}

  {% if show.ownIdentifier and show.ownIdentifier | trim != '' %}
    <span class="type-label-page hdd-page">{{ show.ownIdentifier }}</span>
  {% endif %}
</div>

{% if show.tvChannel or (show.tapers and show.tapers | join("") | trim != '') or show.authoredBy or show.transferredBy %}
<div class="type-cell-page">
  <span class="credits-block" title="Credits" onclick="this.classList.toggle('expanded')">
    {% if show.tapers and show.tapers.length > 0 and show.tapers | join("") | trim != '' %}
      <strong>{% if show.tapers.length == 1 %}Taper:{% else %}Tapers:{% endif %}</strong> {{ show.tapers | join(", ") }}
    {% endif %}
    {% if show.authoredBy %}
      <strong>Authored By:</strong> {{ show.authoredBy }}
    {% endif %}
    {% if show.transferredBy %}
      <strong>Transferred By:</strong> {{ show.transferredBy }}
    {% endif %}
    {% if show.tvChannel %}
      <strong>TV Channel:</strong> {{ show.tvChannel }}
    {% endif %}
  </span>
</div>
{% endif %}

<div style="position: relative;">
  {% if show.tradeLabel == 'RT' %}
    <span class="trade-label-page red-page">RT</span>
  {% elif show.tradeLabel == 'NT' %}
    <span class="trade-label-page blue-page">NT</span>
  {% endif %}

  {% if show.master == true or (show.tapers and show.tapers.length == 1 and show.tapers[0] == "Vortex") %}
  <span class="trade-label-page master-page">MASTER</span>
  {% endif %}
</div>
<div class="table-wrapper" style="margin-top: 5px;">
  <table>
    <thead>
      <tr>
        <th>Band</th>
        <th>Date</th>
        <th>City</th>
        <th>State</th>
        <th>Country</th>
		<th>Venue</th>
        <th>Event</th>
		<th>Source</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>
          {% if show.bands and show.bands.length %}
            {{ show.bands | join(", ") }}
          {% else %}
            —
          {% endif %}
        </td>
        <td>
          {% if show.startDateUnix %}
            {{ show.startDateUnix | date("yyyy-MM-dd") }}
          {% elif show.startDate %}
            {% set sd = show.startDate %}
            {% if sd.day and sd.month and sd.year %}
              {{ sd.year }}-{{ sd.month }}-{{ sd.day }}
            {% elif sd.month and sd.year %}
              {{ sd.year }}-{{ sd.month }}
            {% elif sd.year %}
              {{ sd.year }}
            {% else %}
              —
            {% endif %}
          {% else %}
            —
          {% endif %}
        </td>
        <td>{{ show.location.city or "—" }}</td>
        <td>{{ show.location.state or "—" }}</td>
        <td>{{ show.location.country or "—" }}</td>
		<td>{{ show.location.venue or "—" }}</td>
        <td>
          {% if show.location.event and show.showName %}
            {{ show.location.event }}<br>{{ show.showName }}
          {% elif show.location.event %}
            {{ show.location.event }}
          {% elif show.showName %}
            {{ show.showName }}
          {% else %}
            —
          {% endif %}
        </td>
		<td>{{ show.source or "—" }}</td>
      </tr>
    </tbody>
  </table>
</div>
<div class="table-wrapper" style="margin-top: 10px;">
  <table>
    <thead>
      <tr>
        <th>Details</th>
        <th>Images</th>
        <th>Setlist</th>
      </tr>
    </thead>
    <tbody>
      <tr>
      <td style="vertical-align: top; text-align: left;">
      <!-- DETAILS -->
<div>
  <strong>Size:</strong>
  {% if show.specs and show.specs.media and show.specs.media.length %}
    {% set media = show.specs.media %}
    {% set main = media[0] %}
    <span>{{ main.size | smartSize }}{{ main.unit }}</span>
    {% if media.length > 1 %}
      <a href="#" class="toggle-media" data-target="media-toggle">▾ +{{ media.length - 1 }}</a>
    {% endif %}
  {% else %}
    —
  {% endif %}
</div>

{% if show.specs and show.specs.media and show.specs.media.length > 1 %}
<div id="media-toggle" class="extra-media indent-block-size" style="display: none;">
  {% for medium in show.specs.media.slice(1) %}
    <div>{{ medium.size | smartSize }}{{ medium.unit }}</div>
  {% endfor %}
</div>
{% endif %}

        <strong>Length:</strong> {{ show.specs.length | formatTime }}<br>
<!-- VIDEO -->
<div>
  <strong>Video:</strong>
  {% if show.specs.video and show.specs.video.length %}
    {% set videos = show.specs.video %}
    {% set v = videos[0] %}
    {{ v.tvFormat }}
    {% if v.ratio %} ({{ v.ratio }}){% endif %}
    {{ v.standard }}
    {% if v.codec %} ({{ v.codec }}){% endif %}
    {{ v.resolution }}
    {% if v.fps %} {{ v.fps }}fps{% endif %}
    {% if v.bitrateType %} {{ v.bitrateType }}{% endif %}
    {% if v.bitrateKbps %} {{ v.bitrateKbps }}kbps{% endif %}
    {% if v.letterboxed %} {{ v.letterboxed }}{% endif %}
    {% if videos.length > 1 %}
      <a href="#" class="toggle-media" data-target="video-toggle">▾ +{{ videos.length - 1 }}</a>
    {% endif %}
  {% else %}
    —
  {% endif %}
</div>

{% if show.specs.video and show.specs.video.length > 1 %}
<div id="video-toggle" class="extra-media indent-block-video" style="display: none;">
  {% for vid in show.specs.video.slice(1) %}
    <div>
      {{ vid.tvFormat }}
      {% if vid.ratio %} ({{ vid.ratio }}){% endif %}
      {{ vid.standard }}
      {% if vid.codec %} ({{ vid.codec }}){% endif %}
      {{ vid.resolution }}
      {% if vid.fps %} {{ vid.fps }}fps{% endif %}
      {% if vid.bitrateType %} {{ vid.bitrateType }}{% endif %}
      {% if vid.bitrateKbps %} {{ vid.bitrateKbps }}kbps{% endif %}
      {% if vid.letterboxed %} {{ vid.letterboxed }}{% endif %}
    </div>
  {% endfor %}
</div>
{% endif %}
        <strong>Audio:</strong>
          {% if show.specs.audio and show.specs.audio.length %}
            {% set a = show.specs.audio[0] %}
            {{ a.codec }} {{ a.channels }}ch @ {{ a.rateHz }}Hz
          {% endif %}<br>
        <strong>Recording Type:</strong> {{ show.specs.sourceDetail.recordingType }}<br>
        <strong>Source Media:</strong> {{ show.specs.sourceDetail.sourceMediaType }}<br>
        <strong>Final Format:</strong> {{ show.specs.sourceDetail.finalMediaType }}<br>
        <strong>File Format:</strong> {{ show.specs.sourceDetail.fileFormat }}<br>
      </td>

      <!-- IMAGES -->
      <td style="vertical-align: top; text-align: left; width: 515px;">
        {% if show.images %}
          <div style="display: inline-block; border: 1px solid #ccc;">
            <div style="display: flex;">
              {% for i in [0, 1] %}
                {% if show.images[i] %}
                  <img
                    src="https://drive.google.com/thumbnail?id={{ show.images[i].externalId }}&sz=w256"
                    width="256"
                    height="128"
                    style="display: block; border-right: 1px solid #ccc; border-bottom: 1px solid #ccc; object-fit: cover; cursor: pointer;"
                    onclick='openModal("{{ show.images[i].externalId }}", {{ show.images | dump | safe }})'>
                {% endif %}
              {% endfor %}
            </div>
            <div style="display: flex;">
              {% for i in [2, 3] %}
                {% if show.images[i] %}
                  <img
                    src="https://drive.google.com/thumbnail?id={{ show.images[i].externalId }}&sz=w256"
                    width="256"
                    height="128"
                    style="display: block; border-right: 1px solid #ccc; object-fit: cover; cursor: pointer;"
                    onclick='openModal("{{ show.images[i].externalId }}", {{ show.images | dump | safe }})'>
                {% endif %}
              {% endfor %}
            </div>
          </div>
        {% else %}
          —
        {% endif %}
      </td>
      <!-- SETLIST -->
      <td style="vertical-align: top; text-align: left;">
        {% if show.setlist and show.setlist.length %}
          <ol style="margin-top: 0;">
            {% for item in show.setlist %}
              <li>
                {{ item.song }}
                {% if item.feat %}<em> feat. {{ item.feat }}</em>{% endif %}
                {% if item.coverOf %} (cover of {{ item.coverOf }}){% endif %}
                {% if item.note %} — <small>{{ item.note }}</small>{% endif %}
              </li>
            {% endfor %}
          </ol>
        {% else %}
          No setlist available.
        {% endif %}
      </td>
      </tr>
    </tbody>
  </table>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  var thumbs = document.querySelectorAll('.image-thumb');
  var modal = document.getElementById('imageModal');
  var modalIframe = document.getElementById('driveViewer');
  var captionText = document.getElementById('caption');
  var closeBtn = document.querySelector('#imageModal .close');
  var nextBtn = document.querySelector('#imageModal .next');
  var prevBtn = document.querySelector('#imageModal .prev');
  var currentIndex = 0;

  thumbs.forEach(function(thumb, idx) {
    thumb.addEventListener('click', function(e) {
      e.preventDefault();
      currentIndex = idx;
      var id = thumb.getAttribute('data-drive-id');
      modal.style.display = 'flex';
      modalIframe.src = 'https://drive.google.com/file/d/' + id + '/preview';
      captionText.textContent = thumb.querySelector('img').alt || '';
    });
  });

  closeBtn.addEventListener('click', function() {
    modal.style.display = 'none';
    modalIframe.src = '';
  });

  nextBtn.addEventListener('click', function() {
    currentIndex = (currentIndex + 1) % thumbs.length;
    thumbs[currentIndex].click();
  });

  prevBtn.addEventListener('click', function() {
    currentIndex = (currentIndex - 1 + thumbs.length) % thumbs.length;
    thumbs[currentIndex].click();
  });

  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      modal.style.display = 'none';
      modalIframe.src = '';
    }
  });
});
</script>
<!-- Modal for image preview -->
<div id="imageModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background-color:rgba(0,0,0,0.7); z-index:1000; align-items:center; justify-content:center;">
  <div style="position:relative; width:90%; height:90%;">
    <span onclick="closeModal()" style="position:absolute; top:11px; right:60px; font-size:2rem; color:white; background-color:rgba(0,0,0,0.6); padding:1px 10px; border-radius:4px; cursor:pointer;">×</span>
	<button id="modalPrev" style="position:absolute; left:10px; top:50%; transform:translateY(-50%); font-size:2rem; background:rgba(0,0,0,0.6); color:white; border:none; padding:8px 12px; cursor:pointer;">←</button>
	<button id="modalNext" style="position:absolute; right:10px; top:50%; transform:translateY(-50%); font-size:2rem; background:rgba(0,0,0,0.6); color:white; border:none; padding:8px 12px; cursor:pointer;">→</button>
    <iframe id="modalImage" style="width:100%; height:100%; border:none; border-radius:0px;"></iframe>
  </div>
</div>

<script>
let currentImages = [];
let currentIndex = 0;

function openModal(id, images = []) {
  currentImages = images;
  currentIndex = images.findIndex(img => img.externalId === id);
  showImageAt(currentIndex);
  const modal = document.getElementById('imageModal');
  if (modal) modal.style.display = 'flex';
}

function showImageAt(index) {
  const img = currentImages[index];
  if (!img) return;

  const iframe = document.getElementById('modalImage');
  if (iframe) iframe.src = `https://drive.google.com/file/d/${img.externalId}/preview`;

  const prevBtn = document.getElementById('modalPrev');
  const nextBtn = document.getElementById('modalNext');

  if (prevBtn) prevBtn.style.display = index > 0 ? 'block' : 'none';
  if (nextBtn) nextBtn.style.display = index < currentImages.length - 1 ? 'block' : 'none';
}

function closeModal() {
  const modal = document.getElementById('imageModal');
  const iframe = document.getElementById('modalImage');
  if (modal) modal.style.display = 'none';
  if (iframe) iframe.src = '';
  currentImages = [];
  currentIndex = 0;
}

function nextImage() {
  if (currentIndex < currentImages.length - 1) {
    currentIndex++;
    showImageAt(currentIndex);
  }
}

function prevImage() {
  if (currentIndex > 0) {
    currentIndex--;
    showImageAt(currentIndex);
  }
}

document.addEventListener('DOMContentLoaded', () => {
  const nextBtn = document.getElementById('modalNext');
  const prevBtn = document.getElementById('modalPrev');
  const closeBtn = document.querySelector('#imageModal .close');

  if (nextBtn) nextBtn.onclick = nextImage;
  if (prevBtn) prevBtn.onclick = prevImage;
  if (closeBtn) closeBtn.onclick = closeModal;

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeModal();
    if (e.key === 'ArrowRight') nextImage();
    if (e.key === 'ArrowLeft') prevImage();
  });

  document.addEventListener("click", function(e) {
      if (e.target.matches(".toggle-media")) {
          e.preventDefault();
          const targetId = e.target.dataset.target;
          const block = document.getElementById(targetId);
          if (!block) return;

          const isVisible = block.style.display === "block";
          block.style.display = isVisible ? "none" : "block";
          e.target.innerHTML = isVisible ?
              `▾ +${block.children.length}` :
              `▴`;
      }
  });
});
</script>
{% endblock %}